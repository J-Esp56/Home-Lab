_Date: 2025-08-26_

## üìå Summary
In this section ill cover my journey of making VLANS for my network and learning about segmenting and applying firewall rules to the VLANS along with all the errors and corresponding troubleshoots I did.

## üñ•Ô∏è Environment / Context
- **OS/Firmware:** Unifi OS 4.3.9 / Network 9.3.45
- **Location: Home Lab**

## ‚öôÔ∏è Configuration
- Controller: UniFi Network Application v 9.3.45
- Gateway: UCG Ultra (firmware 4.3.9)
- Switch: UniFi 8-port PoE
- Access Points:
  - U7 Lite (Living Room) 
  - U7 Lite (Main Bedroom) 
  - U7 LR (Backyard) 

### VLANs
- VLAN 1: Main LAN (192.168.1.0/24)
- VLAN 10: Guest WiFi (192.168.10.0/24)
- VLAN 20: IOT Devices (192.168.20.0/24)

### WIFI SSIDS
Main/IOT/GUESTS
### Firewall Rules
- ACCEPT SECURED VLAN ‚Üí IOT VLAN 
- ACCEPT BACKYARD TV (IP) ‚Üí SECURED VLAN (ON PORTS 7000,7100,55443,6000-7000,32768-65535,5353)
- ACCEPT GUEST VLAN ‚Üí BACKYARD TV(IP)
- ACCEPT BACKYARD TV  ‚Üí GUEST VLAN (ON PORTS 7000,7100,55443,6000-7000,32768-65535,5353)
- DROP IOT VLAN  ‚Üí SECURED VLAN
- DROP GUEST VLAN ‚Üí IOT VLAN
- DROP IOT VLAN  ‚Üí GUEST VLAN
- DROP GUEST VLAN ‚Üí SECURED VLAN

  
**Explanation:** This allows for my secured LAN to talk to my tv for streaming (will add more exceptions if needed for other IOT devices with bidirectional connections). This also forbids Guests to talk to my IOT and Secured devices with the exception of my backyard tv for when guests stream for fight night.

**USEFUL TIPS:**

**Drop** = firewall throws packet away

**Reject** = Firewall actively replies to connection attempt faster but less stealthy  

**All rules go top down in priority**

## üîß Steps Taken
1. **Step One**
   
Opened Unifi UI and made a guest profile to set download limits 100Mbps and Upload limits 30Mbps.

3. **Step Two**
   
Made a new wifi network ssid for guests (applied profile) and configured it to my U7 lite in my bedroom to test initially.

5. **Step Three**
   
Made an IOT ssid and pushed that along with the guests SSID to all AP's

7. **Step Four**
   
Moved Backyard TV to IOT devices as a testing ground for streaming and tested all wifis to make sure connection was solid using wifiman (unifi application)
 
**-What Was Checked For On WifiMan ?**

- Proper dbm
  
- Good Throughput Threshold For Guests (100mbps)
<br>

5. **Step Five**
   
Configured Firewall Rules (See Above) & Additional testing (Airplay connectivity)

7. **Step Six**
   
Once cleared moved all IOT devices to designated SSID and configured Ports on switch to proper VLANs

## üö® Troubleshooting / Errors

- **Error 1a:**

  Couldn't do multi-cast dns per service such as airplay or printing services only. Allowing guests to talk to airplay/chrome cast services but not connect to anything else or allow devices like a printer or other IOT to make any outbound request but that wasn't allowed. Its either all multicasts or no multicasts .
  <br>
![MultiCast DNS Issue](assets/MultiCastDNS.png)


- **How it was fixed:**  
Did see avahi reflector solution (Cleaner and allows per service repeater) but didn't find a need to do it on a server. Forced Firewall rules to not allow connection to Printers/Other IOT etc. besides backyard TV.
---
- **Error 1b:**

   Not allowing connection to airplay due to needing Bi-Directional communication.

  e.g  phone discovers tv then tv responds and tries to **Start a new connection** therefore blocking all new traffic isn't allowed for it to work.

- **How it was fixed:**
  
  Fixing the issue was simple but time consuming, upon looking up the ports airplay used to connect I opened them up so that the TV can communicate back to the SecuredVLAN through those ports however, what wasn't so apparent are the ephemeral ports Airplay uses to actually stream the content. This led to a connection establishing on the TV and on my phone but it froze and broke the connection (most likely due to idle or no response from receiver). Initially I opened ephemeral ports (~54k-~65k) however this didn't work as apple uses midrange ports as well therefore, i opened up (~32k-~65k) and got video to stream through fine.
## ‚úÖ Outcome

- **What worked in the end**  
  Referencing technical documents apple published for Airplay connections allowed me to find certain ports. 

 **Lessons learned :**  
 
   - By default on UNIFI , all VLANs can talk to each other (east‚Äìwest)
Think of it like this:
- A ‚Äúblock rule‚Äù prevents **initiating traffic** in that direction.
- An ‚Äúallow rule‚Äù lets one side initiate, and the other can respond. 
  -**Unless a NEW connection is being made.**

- Unicast traffic works from VLAN to VLAN as long as the initial connection is made through a privileged VLAN
  e.g my PC on SECUREDVLAN to a guest computer directly due to ALLOW rule being set HOWEVER, Broadcast traffic like mDNS is specific only to its exact VLAN unless a repeater is on. This is why if the client is on SECURED VLAN i cant see mDNS from the server in the IOT VLAN
  
## üîó References
- **Links, docs, or tutorials used**

**VLANs Made Easy Video**
- https://youtu.be/JszGeQPTo4w?si=ArUxierS3HKpNpVI
- CHATGPT for troubleshooting

### üí¢Corrections (IF NEEDED)
